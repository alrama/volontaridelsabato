<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="theme-color" content="darkolivegreen">
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0">
<link rel="icon" href="favicon.ico" />
<link rel="stylesheet" href="paniniweb.css?v=7"/>
<script src="jquery-3.3.1.min.js"></script>
<script src="model.js?v=8"></script>
<script src="paniniweb.js?v=6"></script>
<script>
initModel(function(){
  if (user==undefined)
    location.replace("./login.html");
  else {
    loadAlimenti();
    if (user.admin) {
      $("#pencil_plus").css('visibility','visible');
      $("#fasi_link").css('display','inline');
    }
  }
});
function displayAlimenti() {
  var htmlcontant = "";
  for (alimento of alimentiObj.alimenti_qta) {
      htmlcontant += "<div class='riga'><div class='textsmall' onclick='dettaglio_riga(this,\""+volontario.email+"\")'>";
      if (volontario.nome.length+volontario.cognome.length<5) {
        htmlcontant+=volontario.nome + " " + volontario.cognome + "</div>";
        htmlcontant+="<div class='textsmall' onclick='dettaglio_riga(this,\""+volontario.email+"\")'>"+volontario.email+"</div>";
      } else {
        htmlcontant+=volontario.nome + "</div>";
        htmlcontant+="<div class='textsmall dettaglio_riga' onclick='dettaglio_riga(this,\""+volontario.email+"\")'>"+volontario.cognome+"</div>";
      }
      if (navigator.userAgent.toLowerCase().indexOf('mobile')>-1 && volontario.cellulare!=null && volontario.cellulare!="") {
        htmlcontant+="<a href='tel:+39"+volontario.cellulare+"'><img src='img/phone-forward.png' class='img_title icon_header' style='float:right;margin-top:-40px;margin-right:60px'/></a>";
        htmlcontant+="<a href='https://api.whatsapp.com/send?phone=39"+volontario.cellulare+"'><img src='img/chat-processing.png' class='img_title icon_header' style='float:right;margin-top:-40px'/></a>"
      }
      htmlcontant+="</div>"
    }
    $("#volontari_content").html(htmlcontant);
}
function loadAlimenti() {
  showMessage('Attendere. Caricamento dati in corso');
  NetworkHelper.getAlimenti(function() {
    if (alimentiObj==undefined || alimentiObj.alimenti_qta==undefined || alimentiObj.alimenti_qta.length==0) {
      showMessage("Nessun alimento presente");
    } else {
      showMessage("");
      displayAlimenti();
    }
    $("#dataagg").html(new Date().toLocaleDateString("it-IT"));
  });
}
function addAlimenti() {
  $("#detail").css('display','inline');
  $("#detail").css('left',$('#alimenti_content').offset().left);
  $('#alimento').val('');
  $('#unita').val('');
  $('#quantita').val('');
  $('#scadenza').val('');
}
function selectAlimento(alim) {
  $("#suggest_content").css("display","none");
  $('#alimento').val(alim);
  var alimQta = findQuantitaAlimento(alim);
  if (alimQta!=null) {
    var misura = findMisuraById(alimQta.misura_id);
    $('#unita').val(misura);
    $('#quantita').val(alimQta.quantita);
    $('#scadenza').val(alimQta.scadenza);
  }
}
function suggestAlimenti() {
  var htmlcontant = "<div class='sublist'>";
  if (alimentiObj.alimenti!=null && alimentiObj.alimenti.length>0) {
    var filtro = $('#alimento').val().toLowerCase();
    for (alimento of alimentiObj.alimenti) {
      if (filtro.length==0 || alimento.nome.indexOf(filtro)>-1
     || alimento.nome.toLowerCase().indexOf(filtro)>-1  || alimento.nome.toUpperCase().indexOf(filtro)>-1)
        htmlcontant += "<div class='riga' onclick='selectAlimento(\""+alimento.nome+"\");'>"+alimento.nome+"</div>";
    }
    htmlcontant+="</div><input type=\"button\" class=\"login compat_button\" style=\"margin-top:5px;\" value=\"Chiudi\" onclick=\"$('#suggest_content').css('display','none')\">";
    setSuggestBox($('#alimento'),htmlcontant);
  }
}
function selectMisura(misura) {
  $('#unita').val(misura);
  $("#suggest_content").css("display","none");
}
function suggestMisure() {
  var htmlcontant = "<div class='sublist'>";
  if (alimentiObj.alimenti_misure!=null && alimentiObj.alimenti_misure.length>0) {
    var filtro = $('#unita').val().toLowerCase();
    for (misura of alimentiObj.alimenti_misure) {
      if (misura.nome.length>0 && (filtro.length==0 || misura.nome.indexOf(filtro)>-1
     || misura.nome.toLowerCase().indexOf(filtro)>-1  || misura.nome.toUpperCase().indexOf(filtro)>-1))
        htmlcontant += "<div class='riga' onclick='selectMisura(\""+misura.nome+"\");'>"+misura.nome+"</div>";
    }
    htmlcontant+="</div><input type=\"button\" class=\"login compat_button\" style=\"margin-top:5px;\" value=\"Chiudi\" onclick=\"$('#suggest_content').css('display','none')\">";
    setSuggestBox($('#unita'),htmlcontant);
  }
}
function setSuggestBox(elem,htmlcontent) {
  $("#suggest_content").html(htmlcontent);
  $("#suggest_content").css("display","block");
  $('#suggest_content').css('top',(elem.offset().top+40)+'px');
  $('#suggest_content').css('left',$('#detail').offset().left+'px');
}
function closeDetail() {
  $("#detail").css("display","none");
  $("#suggest_content").css("display","none");
}
function sendAlimento() {
  if ($('#alimento').val() && $('#quantita').val()) {
    showMessage('Invio aggiornamenti in corso');
    var alim = {};
    alim.nome = $('#alimento').val();
    alim.misura = $('#unita').val();
    alim.quantita = $('#quantita').val();
    alim.scadenza = $('#scadenza').val();
    var req = {};
    req.onsuccess = function() {
      showMessage("Alimento registrato")
    };
    req.onerror = function() {showMessage("Impossibile registrare l'alimento. Riprovare più tardi");};
    NetworkHelper.sendAlimento(alim,req);
  }
}
</script>
<title>Volontari del sabato</title>
</head>

<body>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a href="evento.html">Prossima distribuzione</a>
    <a href="volontari.html">Volontari</a>
    <a href="avvisi.html">Avvisi</a>
    <a href="fasi.html" id="fasi_link" style="display:none;">Gestione Fasi</a>
    <a href="javascript:void(0)"  onclick="logout()">Logout</a>
  </div>

  <!-- Use any element to open the sidenav -->
  <img onclick="openNav()" src="img/menu.png">
  <h2>Alimenti disponibili al: <span id='dataagg'>-<span></h2>
  <div class="message" id="message"></div>
  <div class="main">
    <div class="header_content" style="margin-top:10px">
      <img id="pencil_plus" onclick="addAlimenti();" src="img/pencil-plus.png" style="visibility:hidden" class="icon_header img_title">
    <img onclick="loadAlimenti();" src="img/sync.png" class="icon_header img_title"></div>
    <div id="alimenti_content"></div>
  </div>
  <div id="detail" class="detail" style="display: none;margin:auto;position:absolute;top:150px">
    <label for="alimento" class="textsmall">Tipo alimento</label><br/>
    <input type="text" class="spacedfield" id="alimento" onchange='suggestAlimenti()' onkeyup="suggestAlimenti()"><br/>
    <label for="unita" class="textsmall">Unità di misura</label><br/>
    <input type="text" class="spacedfield" id="unita" onchange='suggestMisure()' onkeyup="suggestMisure()"><br/>
    <label for="quantita" class="textsmall">Quantità</label><br/>
    <input type="number" class="spacedfield" id="quantita"><br/>
    <label for="scadenza" class="textsmall">Scadenza</label><br/>
    <input type="date" class="spacedfield" id="scadenza"><br/>
    <input type="button" class="login compat_button" style="margin-top:5px" value="Chiudi" id="chiudi" onclick='closeDetail();'>
    <input type="button" class="login compat_button" style="margin-top:5px" value="Aggiungi" id="aggiungi" onclick='sendAlimento();'>
    </div>
  <div id="suggest_content"  class="detail" style="display: none;background: white"></div>
    <br/>
  </div>

</body>

</html>
