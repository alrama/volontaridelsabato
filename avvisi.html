<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0">
<link rel="icon" href="favicon.ico" />
<link rel="stylesheet" href="paniniweb.css?v=3"/>
<script src="jquery-3.3.1.min.js"></script>
<script src="model.js?v=3"></script>
<script src="paniniweb.js?v=2"></script>
<script>
var ultima_data = 0;
function setCounter() {
  $('#counter').text($('#testo_avviso').val().length+'/250');
}
function findNewAvvisi() {
  var req = {};
  req.onsuccess = function() {
    showMessage("");
    if (avvisi && avvisi.length>0) ultima_data=avvisi[0].inserito;
    var prehtml = $('#avvisi').html();
    var html= "";
    for (var i = 0;i<avvisi.length;i++) {
      html+="<div class='subtitle' style='text-align:left'>"+avvisi[i].inserito.substring(0,16)+"</div>";
      html+="<div class='textsmall' style='font-weight:bold;text-align:left'>" + avvisi[i].testo +"</div>" ;
    }
    $('#avvisi').html(html+prehtml);
  }
  showMessage("Recupero ultimi avvisi in corso...");
  NetworkHelper.getAvvisi(ultima_data,req);
}
function displayAvvisi() {
  var html= "";
  for (var i = 0;i<avvisi.length;i++) {
    html+="<div class='subtitle' style='text-align:left'>"+avvisi[i].inserito.substring(0,16)+"</div>";
    html+="<div class='textsmall' style='text-align:left'>" + avvisi[i].testo +"</div>" ;
  }
  $('#avvisi').html(html);
  if (avvisi && avvisi.length>0) ultima_data=avvisi[0].inserito;
  findNewAvvisi();
}
initModel(function(){
  if (user==undefined)
    location.replace("./login.html");
  else {
    StorageHelper.getAvvisi(displayAvvisi);
    if (user.admin) $("#post_plus").css('visibility','visible');
  }
});
function scriviPost() {
  $("#detail").css("display","block");
  $("#detail").css('top',$('#avvisi').offset().top);
  $("#detail").css('left',$('#avvisi').offset().left);
}
function closeScrivi() {
  $("#detail").css("display","none");
}
function sendAvviso() {
  if ($('#testo_avviso').val().length>0) {
    $("#detail").css("display","none");
    var req = {};
    req.onsuccess = findNewAvvisi;
    req.onerror = function() {showMessage("Errore. Avviso non registrato");};
    NetworkHelper.sendAvviso($('#testo_avviso').val(),req);
  } else showMessage('Il testo dell\'avviso Ã¨ assente');
}
</script>
<title>Volontari del sabato</title>
</head>

<body>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a href="evento.html">Prossima distribuzione</a>
    <a href="volontari.html">Volontari</a>
    <a href="avvisi.html">Avvisi</a>
    <a href="javascript:void(0)"  onclick="logout()">Logout</a>
    <a href="register.html">Registrazione</a>
  </div>

  <!-- Use any element to open the sidenav -->
  <img onclick="openNav()" src="img/menu.png">
  <h2>Avvisi</h2>
  <div class="message" id="message"></div>
  <div class="main">
    <div class="header_content">
      <img id="post_plus" onclick="scriviPost();" src="img/post-plus.png" style="visibility:hidden" class="icon_header img_title">
    <img onclick="findNewAvvisi();" src="img/sync.png" class="icon_header img_title"></div>
    <div id="avvisi"></div>
  </div>
  <div id="detail" class="detail" style="display: none;">
    <label for="testo" class="textsmall">testo dell'avviso</label><br/>
    <textarea class="smallfield" id="testo_avviso" onkeyup="setCounter();" onchange="setCounter();" style="height:200px" maxlength="250"></textarea>
    <div style="text-align:right;width:200px"><span id="counter"/>0/250</div><br/>
    <input type="button" class="login compat_button" style="margin-top:5px" value="Chiudi" id="chiudi" onclick='closeScrivi();'>
    <input type="button" class="login compat_button" style="margin-top:5px" value="Invia" id="aggiungi" onclick='sendAvviso();'>
  </div>

</body>

</html>
