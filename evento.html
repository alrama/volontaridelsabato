<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0">
<link rel="icon" href="favicon.ico" />
<link rel="stylesheet" href="paniniweb.css"/>
<script src="jquery-3.3.1.min.js"></script>
<script src="model.js"></script>
<script src="paniniweb.js"></script>
<script>
function creaEvento() {
  $('#message').text('Attendere, salvataggio e sincronizzazione in corso.')
  evento.data_evento = $("#evento_picker").val();
  var req = {};
  req.onsuccess = function() {
    displayEvento();
    var netreq = {};
    netreq.onsuccess = function() {
      $('#message').text('OK. Salvato e sincronizzato');
    };
    netreq.onerror = function(serviceResponse) {
      if (serviceResponse.response_code==undefined)
        $('#message').html("Server non raggiungibile. Senza sincronizzazione non sono consentite altre modifiche<br/><span class='collegamento' onclick='sincronizza();'>Ritenta la sincronizzazione</span>");
      else $('#message').html("Sincronizzazione non possibile. Il server ha dati pi√π aggiornati<br/><span class='collegamento' onclick='aggiornaEvento();'>Aggiorna dati locali</span>");
    };
    NetworkHelper.sendEvento(netreq);
  };
  req.onerror = function() {

  }
  StorageHelper.saveEvento(req);
}
function scegliData() {
  $("#message").html("");
  $("#evento_picker").css('display','block');
}
function displayEvento() {

}
function loadVolontari() {}
function loadEvento() {
  $("#message").text('Attendere. Caricamento dati in corso');
  StorageHelper.getEvento(function() {
    if (evento==undefined || evento.data_evento==null) {
      $("#message").text('Attendere. Richiesta dati remoti');
      NetworkHelper.loadEvento(function() {
        if (evento.fasi) {
          if (evento.data_evento) {
            StorageHelper.saveEvento();
            displayEvento();
            loadVolontari();
          } else {
            var text = "Nessun evento programmato.";
            if (user.admin) text += "<br/><span class='collegamento' onclick='scegliData();'>Premi per scegliere la prossima data</span>";
            $("#message").html(text);
          }
        } else $("#message").text('Errore. Nessun template disponibile');
      });
    } else {
      StorageHelper.getBacklog(function() {
        if (backlog) {
          $("#message").html("Senza sincronizzazione non sono consentite altre modifiche<br/><span class='collegamento' onclick='sincronizza();'>Ritenta la sincronizzazione</span>")
        } else $("#message").html("");
      });
    }
  });
}
initModel(function(){
  if (user==undefined)
    location.replace("./login.html");
  else loadEvento();
});
</script>
<title>Volontari del sabato</title>
</head>

<body>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a href="evento.html">Prossima distribuzione</a>
    <a href="volontari.html">Volontari</a>
    <a href="login.html">Login</a>
    <a href="register.html">Registrazione</a>
  </div>

  <!-- Use any element to open the sidenav -->
  <img onclick="openNav()" src="img/menu.png">
  <h2>Volontari del sabato</h2>
  <div class="main">
  <div class="message" id="message"></div>
    <input type="date" style="display:none" id="evento_picker" class='login' onchange="creaEvento();">
  </div>
</body>

</html>
